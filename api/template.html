<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>×™×•×¦×¨ ×–Ö°××•Ö¼× Ö¸×” ×œ×©×‘×ª ×•×—×’ âœ¡</title>

  <!-- Favicons - Vercel serves public/ files from root -->
  <link rel="icon" type="image/x-icon" href="/static/favicon.ico" />
  <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="48x48" href="/static/favicon-48x48.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png" />
  <!-- Fallback for local development -->
  <link rel="shortcut icon" href="/static/favicon.ico" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; }
    body { font-family: 'Heebo', system-ui, -apple-system, BlinkMacSystemFont, sans-serif; background: linear-gradient(135deg, #1a237e 0%, #283593 50%, #3949ab 100%); margin: 0; padding: 20px; min-height: 100vh; }
    .container { background: #ffffff; margin: 0 auto; padding: 32px; border-radius: 24px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-width: 520px; width: 100%; }
    .header { text-align: center; margin-bottom: 28px; }
    .logo { font-size: 48px; margin-bottom: 8px; }
    .logo-img { width: 80px; height: auto; }
    h1 { margin: 0; font-size: 28px; font-weight: 700; color: #1a237e; }
    .subtitle { color: #5c6bc0; font-size: 14px; margin-top: 6px; }
    .form-group { margin-bottom: 20px; }
    label { display: block; margin-bottom: 8px; font-weight: 600; color: #1a237e; font-size: 15px; }
    label .optional { font-weight: 400; color: #9e9e9e; font-size: 13px; }
    input[type="text"], textarea { width: 100%; padding: 14px 16px; border-radius: 12px; border: 2px solid #e8eaf6; font-size: 15px; font-family: inherit; transition: border-color 0.2s ease, box-shadow 0.2s ease; background: #fafafa; }
    input[type="text"]:focus, textarea:focus { outline: none; border-color: #5c6bc0; box-shadow: 0 0 0 4px rgba(92, 107, 192, 0.15); background: #fff; }
    textarea { resize: vertical; min-height: 80px; }
    .hint { font-size: 12px; color: #9e9e9e; margin-top: 6px; display: flex; align-items: center; gap: 4px; }
    .hint::before { content: "ğŸ’¡"; font-size: 11px; }
    .dedication-add-btn { display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; padding: 14px 16px; border-radius: 12px; border: 2px dashed #c5cae9; background: #f5f5ff; color: #3949ab; font-size: 15px; font-weight: 500; cursor: pointer; transition: all 0.2s ease; font-family: inherit; }
    .dedication-add-btn:hover { border-color: #5c6bc0; background: #ede7f6; }
    .dedication-section { display: none; animation: fadeIn 0.3s ease; }
    .dedication-section.show { display: block; }
    .dedication-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
    .dedication-header label { margin-bottom: 0; }
    .dedication-close-btn { background: none; border: none; color: #9e9e9e; font-size: 20px; cursor: pointer; padding: 4px 8px; border-radius: 6px; transition: all 0.15s ease; line-height: 1; }
    .dedication-close-btn:hover { background: #ffebee; color: #e53935; }
    .advanced-toggle { display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%; padding: 12px 16px; border-radius: 10px; border: 1px solid #e0e0e0; background: #fafafa; color: #666; font-size: 14px; cursor: pointer; transition: all 0.2s ease; font-family: inherit; margin-top: 8px; }
    .advanced-toggle:hover { background: #f5f5f5; border-color: #bdbdbd; color: #424242; }
    .advanced-toggle.open { background: #e8eaf6; border-color: #5c6bc0; color: #3949ab; }
    .advanced-toggle .arrow { transition: transform 0.2s ease; }
    .advanced-toggle.open .arrow { transform: rotate(180deg); }
    .advanced-section { display: none; margin-top: 16px; padding: 16px; border: 2px solid #e8eaf6; border-radius: 12px; background: #fafafa; }
    .advanced-section.show { display: block; }
    .advanced-title { font-size: 14px; font-weight: 600; color: #3949ab; margin-bottom: 12px; display: flex; align-items: center; gap: 6px; }
    /* Searchable date dropdown */
    .date-dropdown-container { position: relative; margin-bottom: 16px; }
    .date-dropdown-trigger { width: 100%; padding: 12px 16px; border-radius: 10px; border: 2px solid #e8eaf6; background: #fff; color: #3949ab; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: space-between; transition: all 0.2s ease; font-family: inherit; }
    .date-dropdown-trigger:hover { border-color: #c5cae9; background: #f5f5ff; }
    .date-dropdown-trigger.open { border-color: #5c6bc0; border-bottom-left-radius: 0; border-bottom-right-radius: 0; }
    .date-dropdown-trigger .selected-date-info { display: flex; flex-direction: column; align-items: flex-start; }
    .date-dropdown-trigger .selected-event-name { font-weight: 600; }
    .date-dropdown-trigger .selected-event-date { font-size: 12px; color: #7986cb; }
    .date-dropdown-trigger .dropdown-arrow { transition: transform 0.2s ease; }
    .date-dropdown-trigger.open .dropdown-arrow { transform: rotate(180deg); }
    .date-dropdown-menu { display: none; position: absolute; top: 100%; left: 0; right: 0; background: #fff; border: 2px solid #5c6bc0; border-top: none; border-bottom-left-radius: 10px; border-bottom-right-radius: 10px; max-height: 300px; overflow-y: auto; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .date-dropdown-menu.show { display: block; }
    .date-search-input { width: 100%; padding: 10px 14px; border: none; border-bottom: 1px solid #e8eaf6; font-size: 14px; font-family: inherit; background: #fafafa; }
    .date-search-input:focus { outline: none; background: #fff; }
    .date-dropdown-list { max-height: 240px; overflow-y: auto; }
    .date-dropdown-item { padding: 10px 14px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background 0.15s ease; border-bottom: 1px solid #f5f5f5; }
    .date-dropdown-item:hover { background: #f5f5ff; }
    .date-dropdown-item.selected { background: #e8eaf6; }
    .date-dropdown-item.hidden { display: none; }
    .date-dropdown-item .item-name { font-weight: 600; font-size: 13px; color: #3949ab; }
    .date-dropdown-item .item-date { font-size: 12px; color: #7986cb; }
    .date-no-results { padding: 16px; text-align: center; color: #999; font-size: 13px; display: none; }
    .weeks-selector { display: flex; align-items: center; gap: 12px; padding: 12px; background: #fff; border-radius: 8px; border: 1px solid #e0e0e0; }
    .weeks-selector label { font-size: 13px; color: #3949ab; margin: 0; }
    .weeks-input { width: 60px; padding: 8px; border: 1px solid #c5cae9; border-radius: 6px; font-size: 14px; text-align: center; color: #3949ab; }
    .weeks-input:focus { outline: none; border-color: #5c6bc0; }
    .selected-range-info { margin-top: 12px; padding: 10px 14px; background: #e8f5e9; border-radius: 8px; font-size: 13px; color: #2e7d32; display: none; }
    .selected-range-info.show { display: block; }
    .date-format-selector { display: flex; gap: 8px; flex-wrap: wrap; }
    .date-format-option { padding: 8px 16px; border-radius: 8px; border: 2px solid #e8eaf6; background: #fff; color: #3949ab; font-size: 13px; cursor: pointer; transition: all 0.15s ease; }
    .date-format-option:hover { border-color: #c5cae9; background: #f5f5ff; }
    .date-format-option.selected { border-color: #5c6bc0; background: #e8eaf6; font-weight: 600; }
    /* Manual override section */
    .override-section { margin-top: 20px; padding-top: 16px; border-top: 1px solid #e0e0e0; }
    .override-title { font-size: 14px; font-weight: 600; color: #e53935; margin-bottom: 12px; display: flex; align-items: center; gap: 6px; }
    .override-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .override-field { display: flex; flex-direction: column; gap: 4px; }
    .override-field.full-width { grid-column: 1 / -1; }
    .override-label { font-size: 12px; color: #666; font-weight: 500; }
    .override-input { padding: 10px 12px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 14px; font-family: inherit; direction: rtl; transition: border-color 0.15s ease; }
    .override-input:focus { outline: none; border-color: #5c6bc0; }
    .override-input::placeholder { color: #bbb; }
    .override-note { font-size: 11px; color: #999; margin-top: 8px; text-align: center; }
    /* Custom city section */
    .custom-city-section { margin-top: 20px; padding-top: 16px; border-top: 1px solid #e0e0e0; }
    .custom-city-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .custom-city-title { font-size: 14px; font-weight: 600; color: #5c6bc0; }
    .add-custom-city-btn { padding: 6px 12px; background: #5c6bc0; color: white; border: none; border-radius: 6px; font-size: 12px; cursor: pointer; font-family: inherit; transition: background 0.15s ease; }
    .add-custom-city-btn:hover { background: #3949ab; }
    .custom-cities-list { display: flex; flex-direction: column; gap: 10px; }
    .custom-city-entry { display: grid; grid-template-columns: 1fr 80px 80px 32px; gap: 8px; align-items: center; padding: 10px; background: #f5f5ff; border-radius: 8px; border: 1px solid #e0e0e0; }
    .custom-city-entry input { padding: 8px 10px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 13px; font-family: inherit; direction: rtl; }
    .custom-city-entry input:focus { outline: none; border-color: #5c6bc0; }
    .custom-city-entry input::placeholder { color: #bbb; font-size: 11px; }
    .remove-custom-city-btn { width: 28px; height: 28px; border: none; background: #ffebee; color: #e53935; border-radius: 6px; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; transition: background 0.15s ease; }
    .remove-custom-city-btn:hover { background: #ffcdd2; }
    .file-upload-wrapper { position: relative; }
    .file-input-hidden { position: absolute; width: 1px; height: 1px; opacity: 0; overflow: hidden; }
    .file-upload-btn { display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%; padding: 14px 16px; border-radius: 12px; border: 2px dashed #c5cae9; background: #f5f5ff; color: #3949ab; font-size: 15px; font-weight: 500; cursor: pointer; transition: all 0.2s ease; font-family: inherit; }
    .file-upload-btn:hover { border-color: #5c6bc0; background: #ede7f6; }
    .file-upload-btn.has-file { border-style: solid; border-color: #5c6bc0; background: #e8eaf6; }
    .file-name { font-size: 13px; color: #5c6bc0; margin-top: 8px; display: none; align-items: center; gap: 6px; }
    .file-name.show { display: flex; }
    .file-name .clear-file { background: none; border: none; color: #e53935; cursor: pointer; font-size: 16px; padding: 0 4px; line-height: 1; }
    .file-name .clear-file:hover { color: #c62828; }
    .cities-section { border: 1px solid #e0e0e0; border-radius: 10px; padding: 12px; background: #fff; }
    .city-search { width: 100%; padding: 10px 14px; border-radius: 8px; border: 1px solid #e0e0e0; font-size: 14px; font-family: inherit; background: #fafafa; }
    .city-search:focus { outline: none; border-color: #5c6bc0; background: #fff; }
    .selected-chips { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 10px; }
    .selected-chips:empty { display: none; }
    .city-chip { display: inline-flex; align-items: center; gap: 6px; background: #e8eaf6; border: 1px solid #c5cae9; border-radius: 16px; padding: 4px 10px; font-size: 13px; color: #3949ab; }
    .city-chip .chip-name { max-width: 100px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .city-chip .chip-remove { cursor: pointer; font-size: 14px; color: #7986cb; line-height: 1; }
    .city-chip .chip-remove:hover { color: #c62828; }
    .show-all-toggle { display: flex; align-items: center; justify-content: center; gap: 6px; margin-top: 10px; padding: 8px; border: none; background: none; color: #5c6bc0; font-size: 13px; font-family: inherit; cursor: pointer; width: 100%; }
    .show-all-toggle:hover { color: #3949ab; }
    .show-all-toggle .arrow { transition: transform 0.2s ease; }
    .show-all-toggle.open .arrow { transform: rotate(180deg); }
    .cities-grid-wrapper { display: none; margin-top: 10px; border-top: 1px solid #eee; padding-top: 10px; }
    .cities-grid-wrapper.show { display: block; }
    .cities-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; max-height: 200px; overflow-y: auto; }
    .city-option { display: flex; align-items: center; gap: 4px; padding: 6px 8px; border-radius: 6px; background: #fafafa; cursor: pointer; transition: background 0.15s ease; font-size: 12px; }
    .city-option:hover { background: #f0f0f0; }
    .city-option.checked { background: #e8eaf6; }
    .city-option.hidden { display: none; }
    .city-option.disabled { opacity: 0.4; cursor: not-allowed; }
    .city-option .city-check-icon { width: 16px; height: 16px; border-radius: 4px; border: 2px solid #c5cae9; display: flex; align-items: center; justify-content: center; font-size: 11px; color: transparent; transition: all 0.15s ease; flex-shrink: 0; }
    .city-option.checked .city-check-icon { background: #3949ab; border-color: #3949ab; color: #fff; }
    .city-name { color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1; font-size: 12px; }
    .offset-input { display: none; }
    .candle-offset { width: 32px; padding: 2px; border: 1px solid #ccc; border-radius: 4px; font-size: 11px; text-align: center; }
    .offset-label { display: none; }
    .no-results { grid-column: 1 / -1; text-align: center; color: #999; padding: 16px; font-size: 13px; }
    @media (max-width: 400px) { .cities-grid { grid-template-columns: repeat(2, 1fr); } }
    .btn-generate { margin-top: 8px; width: 100%; padding: 16px 24px; border-radius: 14px; border: none; font-size: 18px; font-weight: 700; cursor: pointer; background: linear-gradient(135deg, #ffd54f 0%, #ffb300 100%); color: #1a237e; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 4px 15px rgba(255, 179, 0, 0.4); }
    .btn-generate:disabled { opacity: 0.7; cursor: not-allowed; transform: none; }
    .btn-generate:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(255, 179, 0, 0.5); }
    .btn-generate:active:not(:disabled) { transform: translateY(0); }
    .spinner { width: 20px; height: 20px; border: 3px solid #1a237e; border-top-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite; display: none; }
    .btn-generate.loading .spinner { display: block; }
    .btn-generate.loading .btn-text { display: none; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .status { margin-top: 16px; padding: 12px 16px; border-radius: 10px; font-size: 14px; text-align: center; display: none; }
    .status.show { display: block; }
    .status.error { background: #ffebee; color: #c62828; border: 1px solid #ffcdd2; }
    .status.success { background: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; }
    .status.loading { background: #e8eaf6; color: #3949ab; border: 1px solid #c5cae9; }
    .preview { margin-top: 24px; display: none; animation: fadeIn 0.4s ease; }
    .preview.show { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .preview-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
    .preview-title { font-size: 18px; font-weight: 600; color: #1a237e; margin: 0; display: flex; align-items: center; gap: 8px; }
    .btn-download { padding: 10px 20px; border-radius: 10px; border: 2px solid #1a237e; background: transparent; color: #1a237e; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; gap: 6px; font-family: inherit; }
    .btn-download:hover { background: #1a237e; color: #fff; }
    .preview-image-container { border-radius: 16px; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.15); }
    .preview img { width: 100%; display: block; }
    .footer { margin-top: 28px; text-align: center; color: #9e9e9e; font-size: 12px; }
    .footer a { color: #5c6bc0; text-decoration: none; }
    .footer a:hover { text-decoration: underline; }
    .divider { height: 1px; background: linear-gradient(90deg, transparent, #e0e0e0, transparent); margin: 24px 0; }
    @media (max-width: 480px) { body { padding: 12px; } .container { padding: 24px 20px; border-radius: 20px; } h1 { font-size: 24px; } .logo { font-size: 40px; } .preview-header { flex-direction: column; gap: 12px; align-items: stretch; } .btn-download { justify-content: center; } }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo"><img src="/static/watermark.png" alt="×œ×•×’×•" class="logo-img" /></div>
      <h1>×™×•×¦×¨ ×–Ö°××•Ö¼× Ö¸×” ×œ×©×‘×ª ×•×—×’</h1>
      <div class="subtitle">×¦×¨×• ×–Ö°××•Ö¼× Ö¸×” ×™×¤×” ×¢× ×–×× ×™ ×”×“×œ×§×ª × ×¨×•×ª ×œ×©×‘×ª ××• ×œ×—×’</div>
    </div>

    <div class="form-group">
      <label>×ª××•× ×ª ×¨×§×¢ <span class="optional">(×œ× ×—×•×‘×”)</span></label>
      <div class="file-upload-wrapper">
        <input type="file" id="imageFile" class="file-input-hidden" accept="image/*" multiple />
        <button type="button" id="fileUploadBtn" class="file-upload-btn">
          <span>ğŸ“·</span> ×”×¢×œ×” ×ª××•× ×”
        </button>
        <div id="fileName" class="file-name">
          <span id="fileNameText"></span>
          <button type="button" class="clear-file" id="clearFileBtn" title="×”×¡×¨ ×§×•×‘×¥">âœ•</button>
        </div>
      </div>
      <div class="hint" id="uploadHint">×”×©××™×¨×• ×¨×™×§ ×œ×©×™××•×© ×‘×ª××•× ×ª ×‘×¨×™×¨×ª ×”××—×“×œ</div>
    </div>

    <div class="form-group" id="blessingGroup">
      <button type="button" id="addBlessingBtn" class="dedication-add-btn">
        <span>âœ¨</span> ×”×•×¡×£ ×‘×¨×›×” ××™×©×™×ª
      </button>
      <div id="blessingSection" class="dedication-section">
        <div class="dedication-header">
          <label for="message">×‘×¨×›×” ×œ×–Ö°××•Ö¼× Ö¸×”</label>
          <button type="button" id="closeBlessingBtn" class="dedication-close-btn" title="×”×¡×¨ ×‘×¨×›×”">âœ•</button>
        </div>
        <textarea id="message" placeholder="×œ××©×œ: ×œ×—×™×™ ×©××—×•×ª ×§×˜× ×•×ª ×•×’×“×•×œ×•×ª"></textarea>
        <div class="hint">ğŸ’¡ ××™×Ÿ ×¦×•×¨×š ×œ×›×ª×•×‘ "×©×‘×ª ×©×œ×•×" - ×–×• ×›×‘×¨ ×”×›×•×ª×¨×ª ×”×¨××©×™×ª ×©×œ ×”×–Ö°××•Ö¼× Ö¸×”</div>
      </div>
    </div>

    <div class="form-group" id="dedicationGroup">
      <button type="button" id="addDedicationBtn" class="dedication-add-btn">
        <span>ğŸ•¯ï¸</span> ×”×•×¡×£ ×”×§×“×©×” ×œ×¢×™×œ×•×™ × ×©××ª
      </button>
      <div id="dedicationSection" class="dedication-section">
        <div class="dedication-header">
          <label for="neshama">×œ×¢×™×œ×•×™ × ×©××ª</label>
          <button type="button" id="closeDedicationBtn" class="dedication-close-btn" title="×”×¡×¨ ×”×§×“×©×”">âœ•</button>
        </div>
        <input id="neshama" type="text" placeholder="×œ××©×œ: ××•×¨×™ ×‘×•×¨× ×©×˜×™×™×Ÿ ×”×™×´×“" />
      </div>
    </div>

    <div class="form-group">
      <label>×‘×—×¨ ×¢×¨×™× ×•×™×™×©×•×‘×™×</label>
      <div class="cities-section">
        <input type="text" id="citySearch" class="city-search" placeholder="ğŸ” ×—×¤×© ×¢×™×¨ ××• ×™×™×©×•×‘..." />
        <div id="selectedChips" class="selected-chips"></div>
        <button type="button" id="showAllCitiesBtn" class="show-all-toggle">
          <span>×”×¦×’ ××ª ×›×œ ×”×¢×¨×™×</span>
          <span class="arrow">â–¼</span>
        </button>
        <div id="citiesGridWrapper" class="cities-grid-wrapper">
          <div class="cities-grid" id="citiesGrid">
CITY_CHECKBOXES_PLACEHOLDER
            <div class="no-results" id="noResults" style="display:none;">×œ× × ××¦××• ×¢×¨×™×</div>
          </div>
        </div>
        <!-- Custom Cities Section -->
        <div class="custom-city-section">
          <div class="custom-city-header">
            <span class="custom-city-title">âœï¸ ×¢×¨×™× ××•×ª×××•×ª ××™×©×™×ª</span>
            <button type="button" id="addCustomCityBtn" class="add-custom-city-btn">+ ×”×•×¡×£ ×¢×™×¨</button>
          </div>
          <div id="customCitiesList" class="custom-cities-list"></div>
        </div>
      </div>
    </div>

    <!-- Date Format Selector (Main Menu) -->
    <div class="form-group">
      <label>ğŸ—“ï¸ ×¤×•×¨××˜ ×ª××¨×™×š ×‘×–Ö°××•Ö¼× Ö¸×”</label>
      <div id="dateFormatSelector" class="date-format-selector">
        <div class="date-format-option" data-format="gregorian">×œ×•×¢×–×™</div>
        <div class="date-format-option" data-format="hebrew">×¢×‘×¨×™</div>
        <div class="date-format-option selected" data-format="both">×œ×•×¢×–×™ + ×¢×‘×¨×™</div>
      </div>
    </div>

    <!-- Advanced Options Toggle -->
    <button type="button" id="advancedToggle" class="advanced-toggle">
      <span>âš™ï¸ ××¤×©×¨×•×™×•×ª ××ª×§×“××•×ª</span>
      <span class="arrow">â–¼</span>
    </button>

    <div id="advancedSection" class="advanced-section">
      <div class="advanced-title">ğŸ“… ×‘×—×™×¨×ª ×ª××¨×™×š ×”×ª×—×œ×”</div>

      <!-- Searchable Date Dropdown -->
      <div class="date-dropdown-container">
        <button type="button" id="dateDropdownTrigger" class="date-dropdown-trigger">
          <div class="selected-date-info">
            <span class="selected-event-name" id="selectedEventName">â³ ×˜×•×¢×Ÿ...</span>
            <span class="selected-event-date" id="selectedEventDate"></span>
          </div>
          <span class="dropdown-arrow">â–¼</span>
        </button>
        <div id="dateDropdownMenu" class="date-dropdown-menu">
          <input type="text" id="dateSearchInput" class="date-search-input" placeholder="ğŸ” ×—×¤×© ×œ×¤×™ ×¤×¨×©×” ××• ×ª××¨×™×š..." />
          <div id="dateDropdownList" class="date-dropdown-list"></div>
          <div id="dateNoResults" class="date-no-results">×œ× × ××¦××• ×ª×•×¦××•×ª</div>
        </div>
      </div>

      <div class="weeks-selector">
        <label>××¡×¤×¨ ×©×‘×ª×•×ª/×—×’×™× ×§×“×™××”:</label>
        <input type="number" id="weeksAhead" class="weeks-input" min="1" max="20" value="1" />
      </div>

      <div id="selectedRangeInfo" class="selected-range-info"></div>

      <!-- Manual Override Section -->
      <div class="override-section">
        <div class="override-title">âœï¸ ×“×¨×™×¡×” ×™×“× ×™×ª (××•×¤×¦×™×•× ×œ×™)</div>
        <div class="override-grid">
          <div class="override-field full-width">
            <label class="override-label">×›×•×ª×¨×ª ×¨××©×™×ª</label>
            <input type="text" id="overrideMainTitle" class="override-input" placeholder="×œ×“×•×’××”: ×©×‘×ª ×©×œ×•×, ×—×’ ×©××—, ×©× ×” ×˜×•×‘×”" />
          </div>
          <div class="override-field full-width">
            <label class="override-label">×›×•×ª×¨×ª ××©× ×™×ª (×¤×¨×©×” + ×ª××¨×™×š)</label>
            <input type="text" id="overrideSubtitle" class="override-input" placeholder="×œ×“×•×’××”: ×¤×¨×©×ª ×•×™×©×œ×— | 13-14.12.2025" />
          </div>
        </div>
        <div class="override-note">ğŸ’¡ ×©×“×•×ª ×¨×™×§×™× ×™×©×ª××©×• ×‘×¢×¨×›×™× ×”××•×˜×•××˜×™×™×</div>
      </div>
    </div>

    <button id="generateBtn" class="btn-generate">
      <span class="btn-text">âœ¨ ×¦×•×¨ ×–Ö°××•Ö¼× Ö¸×”</span>
      <div class="spinner"></div>
    </button>

    <div id="status" class="status"></div>

    <div class="preview" id="preview">
      <div class="divider"></div>
      <div class="preview-header">
        <h3 class="preview-title">ğŸ‰ ×”×–Ö°××•Ö¼× Ö¸×” ××•×›×Ÿ!</h3>
        <button id="downloadBtn" class="btn-download">
          <span>â¬‡ï¸</span> ×”×•×¨×“ ×ª××•× ×”
        </button>
      </div>
      <div class="preview-image-container">
        <img id="posterImage" alt="×–Ö°××•Ö¼× Ö¸×” ×©×‘×ª ×©× ×•×¦×¨" />
      </div>
    </div>

    <div class="footer">
      ×œ×–×›×¨ ××•×¨×™ ×‘×•×¨× ×©×˜×™×™×Ÿ ×”×™×´×“ ğŸ•¯ï¸
    </div>
  </div>

  <script>
    const btn = document.getElementById("generateBtn");
    const downloadBtn = document.getElementById("downloadBtn");
    const statusEl = document.getElementById("status");
    const previewEl = document.getElementById("preview");
    const posterImg = document.getElementById("posterImage");
    const fileInput = document.getElementById("imageFile");
    const fileUploadBtn = document.getElementById("fileUploadBtn");
    const fileNameEl = document.getElementById("fileName");
    const fileNameText = document.getElementById("fileNameText");
    const clearFileBtn = document.getElementById("clearFileBtn");
    const advancedToggle = document.getElementById("advancedToggle");
    const advancedSection = document.getElementById("advancedSection");
    const weeksAhead = document.getElementById("weeksAhead");
    const citySearch = document.getElementById("citySearch");
    const citiesGrid = document.getElementById("citiesGrid");
    const citiesGridWrapper = document.getElementById("citiesGridWrapper");
    const selectedChips = document.getElementById("selectedChips");
    const showAllCitiesBtn = document.getElementById("showAllCitiesBtn");
    const noResults = document.getElementById("noResults");
    const cityOptions = document.querySelectorAll(".city-option");
    const addDedicationBtn = document.getElementById("addDedicationBtn");
    const dedicationSection = document.getElementById("dedicationSection");
    const closeDedicationBtn = document.getElementById("closeDedicationBtn");
    const neshamaInput = document.getElementById("neshama");
    const addBlessingBtn = document.getElementById("addBlessingBtn");
    const blessingSection = document.getElementById("blessingSection");
    const closeBlessingBtn = document.getElementById("closeBlessingBtn");
    const messageInput = document.getElementById("message");
    const MAX_CITIES = 8;
    const dateFormatSelector = document.getElementById("dateFormatSelector");

    // Date dropdown elements
    const dateDropdownTrigger = document.getElementById("dateDropdownTrigger");
    const dateDropdownMenu = document.getElementById("dateDropdownMenu");
    const dateSearchInput = document.getElementById("dateSearchInput");
    const dateDropdownList = document.getElementById("dateDropdownList");
    const dateNoResults = document.getElementById("dateNoResults");
    const selectedEventName = document.getElementById("selectedEventName");
    const selectedEventDate = document.getElementById("selectedEventDate");
    const selectedRangeInfo = document.getElementById("selectedRangeInfo");

    // Manual override elements
    const overrideMainTitle = document.getElementById("overrideMainTitle");
    const overrideSubtitle = document.getElementById("overrideSubtitle");

    // Custom city elements
    const addCustomCityBtn = document.getElementById("addCustomCityBtn");
    const customCitiesList = document.getElementById("customCitiesList");

    let currentBlobUrl = null;
    let dedicationEnabled = false;
    let blessingEnabled = false;
    let selectedDates = [];
    let allEvents = [];
    let selectedStartIndex = 0;
    let selectedDateFormat = "both";

    // Date format selector
    dateFormatSelector.querySelectorAll('.date-format-option').forEach(opt => {
      opt.addEventListener('click', () => {
        dateFormatSelector.querySelectorAll('.date-format-option').forEach(o => o.classList.remove('selected'));
        opt.classList.add('selected');
        selectedDateFormat = opt.dataset.format;
      });
    });

    // Advanced options toggle
    advancedToggle.addEventListener("click", () => {
      advancedToggle.classList.toggle("open");
      advancedSection.classList.toggle("show");
    });

    // ===== Date Dropdown Functionality =====
    dateDropdownTrigger.addEventListener("click", () => {
      dateDropdownTrigger.classList.toggle("open");
      dateDropdownMenu.classList.toggle("show");
      if (dateDropdownMenu.classList.contains("show")) dateSearchInput.focus();
    });

    document.addEventListener("click", (e) => {
      if (!e.target.closest(".date-dropdown-container")) {
        dateDropdownTrigger.classList.remove("open");
        dateDropdownMenu.classList.remove("show");
      }
    });

    dateSearchInput.addEventListener("input", () => {
      const query = dateSearchInput.value.trim().toLowerCase();
      let hasResults = false;
      dateDropdownList.querySelectorAll(".date-dropdown-item").forEach(item => {
        const name = (item.dataset.name || "").toLowerCase();
        const parsha = (item.dataset.parsha || "").toLowerCase();
        const dateStr = (item.dataset.datestr || "").toLowerCase();
        if (name.includes(query) || parsha.includes(query) || dateStr.includes(query)) {
          item.classList.remove("hidden"); hasResults = true;
        } else { item.classList.add("hidden"); }
      });
      dateNoResults.style.display = hasResults ? "none" : "block";
    });

    function updateSelectedDates() {
      const weeks = parseInt(weeksAhead.value) || 1;
      selectedDates = [];
      for (let i = 0; i < weeks && (selectedStartIndex + i) < allEvents.length; i++) {
        selectedDates.push(allEvents[selectedStartIndex + i].startDate);
      }
      if (selectedDates.length > 1) {
        const startEvent = allEvents[selectedStartIndex];
        const endEvent = allEvents[selectedStartIndex + selectedDates.length - 1];
        selectedRangeInfo.textContent = `ğŸ“‹ ×™×•×•×¦×¨×• ${selectedDates.length} ×–Ö°××•Ö¼× Ö¸×”×™×: ×-${startEvent.displayName} (${startEvent.dateStr}) ×¢×“ ${endEvent.displayName} (${endEvent.dateStr})`;
        selectedRangeInfo.classList.add("show");
      } else { selectedRangeInfo.classList.remove("show"); }
      dateDropdownList.querySelectorAll(".date-dropdown-item").forEach((item, idx) => {
        item.classList.toggle("selected", idx === selectedStartIndex);
      });
      if (typeof updateUploadHint === 'function') updateUploadHint();
    }

    function selectDate(index) {
      selectedStartIndex = index;
      const event = allEvents[index];
      selectedEventName.textContent = event.displayName;
      selectedEventDate.textContent = event.dateStr;
      dateDropdownTrigger.classList.remove("open");
      dateDropdownMenu.classList.remove("show");
      dateSearchInput.value = "";
      dateDropdownList.querySelectorAll(".date-dropdown-item").forEach(item => item.classList.remove("hidden"));
      dateNoResults.style.display = "none";
      updateSelectedDates();
    }

    async function loadUpcomingEvents() {
      try {
        const resp = await fetch("/upcoming-events");
        allEvents = await resp.json();
        dateDropdownList.innerHTML = allEvents.map((event, i) => `
          <div class="date-dropdown-item ${i === 0 ? 'selected' : ''}" data-index="${i}" data-date="${event.startDate}" data-name="${event.displayName}" data-parsha="${event.parsha || ''}" data-datestr="${event.dateStr}">
            <span class="item-name">${event.displayName}</span>
            <span class="item-date">${event.dateStr}</span>
          </div>
        `).join('');
        if (allEvents.length > 0) {
          selectedEventName.textContent = allEvents[0].displayName;
          selectedEventDate.textContent = allEvents[0].dateStr;
        }
        selectedStartIndex = 0;
        selectedDates = [allEvents[0].startDate];
        dateDropdownList.querySelectorAll('.date-dropdown-item').forEach((item, index) => {
          item.addEventListener('click', () => selectDate(index));
        });
      } catch (err) {
        console.error("Failed to load events:", err);
        selectedEventName.textContent = "×©×‘×ª/×—×’ ×”×§×¨×•×‘";
        selectedEventDate.textContent = "";
        selectedDates = [""];
      }
    }
    loadUpcomingEvents();

    weeksAhead.addEventListener("change", () => { updateSelectedDates(); });

    addBlessingBtn.addEventListener("click", () => { blessingEnabled = true; addBlessingBtn.style.display = "none"; blessingSection.classList.add("show"); messageInput.focus(); });
    closeBlessingBtn.addEventListener("click", () => { blessingEnabled = false; messageInput.value = ""; blessingSection.classList.remove("show"); addBlessingBtn.style.display = "flex"; });

    addDedicationBtn.addEventListener("click", () => { dedicationEnabled = true; addDedicationBtn.style.display = "none"; dedicationSection.classList.add("show"); neshamaInput.focus(); });
    closeDedicationBtn.addEventListener("click", () => { dedicationEnabled = false; neshamaInput.value = ""; dedicationSection.classList.remove("show"); addDedicationBtn.style.display = "flex"; });

    // Helper to escape attribute value for CSS selector (handles quotes in city names)
    function escapeAttrForSelector(val) { return val.replace(/"/g, '\\"'); }

    // Render selected cities as chips
    function renderChips() {
      const checked = document.querySelectorAll('.city-option.checked');
      selectedChips.innerHTML = Array.from(checked).map(opt => {
        const name = opt.dataset.name;
        const displayName = opt.querySelector('.city-name').textContent;
        return `<span class="city-chip" data-name="${name}"><span class="chip-name">${displayName}</span><span class="chip-remove">âœ•</span></span>`;
      }).join('');
      selectedChips.querySelectorAll('.chip-remove').forEach(btn => {
        btn.addEventListener('click', () => {
          const name = btn.closest('.city-chip').dataset.name;
          const opt = document.querySelector(`.city-option[data-name="${escapeAttrForSelector(name)}"]`);
          if (opt) { opt.classList.remove('checked'); opt.dataset.selected = 'false'; }
          renderChips(); updateCityLimit();
        });
      });
    }

    function updateCityLimit() {
      const checked = document.querySelectorAll('.city-option.checked').length;
      cityOptions.forEach(opt => { if (!opt.classList.contains('checked')) { opt.classList.toggle("disabled", checked >= MAX_CITIES); } });
    }

    showAllCitiesBtn.addEventListener("click", () => {
      showAllCitiesBtn.classList.toggle("open");
      citiesGridWrapper.classList.toggle("show");
      showAllCitiesBtn.querySelector("span:first-child").textContent = citiesGridWrapper.classList.contains("show") ? "×”×¡×ª×¨ ×¨×©×™××”" : "×”×¦×’ ××ª ×›×œ ×”×¢×¨×™×";
    });

    cityOptions.forEach(opt => {
      opt.addEventListener("click", (e) => {
        if (e.target.classList.contains("candle-offset")) return;
        if (opt.classList.contains('disabled') && !opt.classList.contains('checked')) return;
        const isChecked = opt.classList.toggle("checked");
        opt.dataset.selected = isChecked ? 'true' : 'false';
        renderChips(); updateCityLimit();
      });
    });

    citySearch.addEventListener("input", () => {
      const query = citySearch.value.trim().toLowerCase();
      if (query) { citiesGridWrapper.classList.add("show"); showAllCitiesBtn.classList.add("open"); showAllCitiesBtn.querySelector("span:first-child").textContent = "×”×¡×ª×¨ ×¨×©×™××”"; }
      let visibleCount = 0;
      cityOptions.forEach(opt => { const name = opt.querySelector(".city-name").textContent.toLowerCase(); if (name.includes(query)) { opt.classList.remove("hidden"); visibleCount++; } else { opt.classList.add("hidden"); } });
      noResults.style.display = visibleCount === 0 ? "block" : "none";
    });

    const uploadHint = document.getElementById("uploadHint");
    function updateUploadHint() {
      const count = selectedDates.length;
      if (count > 1) { uploadHint.textContent = `× ×™×ª×Ÿ ×œ×”×¢×œ×•×ª ×¢×“ ${count} ×ª××•× ×•×ª - ××—×ª ×œ×›×œ ×–Ö°××•Ö¼× Ö¸×”. ×× ×ª×¢×œ×• ×¤×—×•×ª, ×”×ª××•× ×” ×”××—×¨×•× ×” ×ª×©××© ×œ×©××¨.`; uploadHint.style.color = "#5c6bc0"; }
      else { uploadHint.textContent = "×”×©××™×¨×• ×¨×™×§ ×œ×©×™××•×© ×‘×ª××•× ×ª ×‘×¨×™×¨×ª ×”××—×“×œ"; uploadHint.style.color = ""; }
    }

    fileUploadBtn.addEventListener("click", () => { fileInput.click(); });
    fileInput.addEventListener("change", () => {
      if (fileInput.files && fileInput.files.length > 0) {
        const count = fileInput.files.length;
        fileNameText.textContent = count === 1 ? fileInput.files[0].name : `${count} ×ª××•× ×•×ª × ×‘×—×¨×•`;
        fileNameEl.classList.add("show"); fileUploadBtn.classList.add("has-file");
        fileUploadBtn.innerHTML = count === 1 ? "<span>âœ…</span> ×ª××•× ×” × ×‘×—×¨×”" : `<span>âœ…</span> ${count} ×ª××•× ×•×ª × ×‘×—×¨×•`;
      }
    });
    clearFileBtn.addEventListener("click", () => { fileInput.value = ""; fileNameEl.classList.remove("show"); fileUploadBtn.classList.remove("has-file"); fileUploadBtn.innerHTML = "<span>ğŸ“·</span> ×”×¢×œ×” ×ª××•× ×”"; });

    function readFileAsBase64(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = () => { const base64 = reader.result.split(",")[1]; resolve(base64); }; reader.onerror = reject; reader.readAsDataURL(file); }); }

    // Custom city functions
    function addCustomCityEntry() {
      const entry = document.createElement("div");
      entry.className = "custom-city-entry";
      entry.innerHTML = `
        <input type="text" class="custom-city-name" placeholder="×©× ×”×¢×™×¨" />
        <input type="text" class="custom-city-candle" placeholder="×”×“×œ×§×”" />
        <input type="text" class="custom-city-havdalah" placeholder="×”×‘×“×œ×”" />
        <button type="button" class="remove-custom-city-btn">Ã—</button>
      `;
      entry.querySelector(".remove-custom-city-btn").addEventListener("click", () => entry.remove());
      customCitiesList.appendChild(entry);
    }
    function getCustomCities() {
      const cities = [];
      customCitiesList.querySelectorAll(".custom-city-entry").forEach(entry => {
        const name = entry.querySelector(".custom-city-name").value.trim();
        const candle = entry.querySelector(".custom-city-candle").value.trim();
        const havdalah = entry.querySelector(".custom-city-havdalah").value.trim();
        if (name) cities.push({ name, candle, havdalah });
      });
      return cities;
    }
    addCustomCityBtn.addEventListener("click", addCustomCityEntry);

    let generatedPosters = [];
    btn.addEventListener("click", async () => {
      const message = messageInput.value.trim();
      const leiluyNeshama = neshamaInput.value.trim();
      const hideDedication = !dedicationEnabled;
      const hideBlessing = !blessingEnabled;
      const uploadedFiles = fileInput.files;
      const datesToGenerate = selectedDates.length > 0 ? selectedDates : [""];
      const isMultiple = datesToGenerate.length > 1;
      statusEl.textContent = isMultiple ? `â³ ×™×•×¦×¨ ${datesToGenerate.length} ×–Ö°××•Ö¼× Ö¸×”×™×...` : "â³ ×™×•×¦×¨ ××ª ×”×–Ö°××•Ö¼× Ö¸×” ×©×œ×š...";
      statusEl.className = "status loading show"; btn.classList.add("loading"); btn.disabled = true; previewEl.classList.remove("show");
      generatedPosters = [];
      try {
        const imagesBase64 = [];
        if (uploadedFiles && uploadedFiles.length > 0) { for (let f = 0; f < uploadedFiles.length; f++) { imagesBase64.push(await readFileAsBase64(uploadedFiles[f])); } }
        const selectedCities = [];
        document.querySelectorAll('.city-option.checked').forEach(opt => { const cityName = opt.dataset.name; const offsetInput = opt.querySelector(".candle-offset"); const offset = parseInt(offsetInput.value) || 20; selectedCities.push({ name: cityName, candle_offset: offset }); });
        for (let i = 0; i < datesToGenerate.length; i++) {
          const date = datesToGenerate[i];
          const payload = {};
          if (imagesBase64.length > 0) { payload.imageBase64 = imagesBase64[Math.min(i, imagesBase64.length - 1)]; }
          if (message) payload.message = message;
          if (leiluyNeshama) payload.leiluyNeshama = leiluyNeshama;
          if (hideDedication) payload.hideDedication = true;
          if (hideBlessing) payload.hideBlessing = true;
          if (date) payload.startDate = date;
          if (selectedCities.length > 0) payload.cities = selectedCities;
          payload.dateFormat = selectedDateFormat;
          // Add manual overrides if provided
          const mainTitleOverride = overrideMainTitle.value.trim();
          const subtitleOverride = overrideSubtitle.value.trim();
          if (mainTitleOverride) payload.overrideMainTitle = mainTitleOverride;
          if (subtitleOverride) payload.overrideSubtitle = subtitleOverride;
          // Add custom cities if provided
          const customCities = getCustomCities();
          if (customCities.length > 0) payload.customCities = customCities;
          statusEl.textContent = isMultiple ? `â³ ×™×•×¦×¨ ×–Ö°××•Ö¼× Ö¸×” ${i + 1} ××ª×•×š ${datesToGenerate.length}...` : "â³ ×™×•×¦×¨ ××ª ×”×–Ö°××•Ö¼× Ö¸×” ×©×œ×š...";
          const resp = await fetch("/api/poster", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
          if (!resp.ok) { throw new Error("×©×’×™××” ××”×©×¨×ª: " + resp.status); }
          const blob = await resp.blob();
          generatedPosters.push({ blob, date });
        }
        if (currentBlobUrl) URL.revokeObjectURL(currentBlobUrl);
        currentBlobUrl = URL.createObjectURL(generatedPosters[0].blob);
        posterImg.src = currentBlobUrl; previewEl.classList.add("show");
        statusEl.textContent = isMultiple ? `âœ… × ×•×¦×¨×• ${datesToGenerate.length} ×–Ö°××•Ö¼× Ö¸×”×™× ×‘×”×¦×œ×—×”! ×œ×—×¥ ×”×•×¨×“ ×œ×”×•×¨×“×ª ×›×•×œ×.` : "âœ… ×”×–Ö°××•Ö¼× Ö¸×” × ×•×¦×¨ ×‘×”×¦×œ×—×”!";
        statusEl.className = "status success show";
      } catch (err) { console.error(err); statusEl.textContent = "âŒ " + err.message; statusEl.className = "status error show"; }
      finally { btn.classList.remove("loading"); btn.disabled = false; }
    });

    downloadBtn.addEventListener("click", async () => {
      if (generatedPosters.length === 0) return;
      if (generatedPosters.length === 1) { const link = document.createElement("a"); link.href = URL.createObjectURL(generatedPosters[0].blob); link.download = "shabbat-poster.png"; document.body.appendChild(link); link.click(); document.body.removeChild(link); }
      else { for (let i = 0; i < generatedPosters.length; i++) { const link = document.createElement("a"); link.href = URL.createObjectURL(generatedPosters[i].blob); link.download = `shabbat-poster-${i + 1}.png`; document.body.appendChild(link); link.click(); document.body.removeChild(link); await new Promise(r => setTimeout(r, 300)); } }
    });
  </script>
</body>
</html>

